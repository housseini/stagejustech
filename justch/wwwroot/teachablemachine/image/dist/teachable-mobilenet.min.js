/**
 * Minified by jsDelivr using Terser v5.13.1.
 * Original file: /npm/@teachablemachine/image@0.8.5/dist/teachable-mobilenet.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";
/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */var __extends=this&&this.__extends||function(){var t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])},t(e,a)};return function(e,a){function r(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(t,e,a,r){return new(a||(a=Promise))((function(n,i){function o(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(o,s)}l((r=r.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var a,r,n,i,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,r&&(n=2&i[0]?r.return:i[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,i[1])).done)return n;switch(r=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){o.label=i[1];break}if(6===i[0]&&o.label<n[1]){o.label=n[1],n=i;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(i);break}n[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],r=0}finally{a=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createTeachable=exports.TeachableMobileNet=void 0;var tf=require("@tensorflow/tfjs"),tfjs_1=require("@tensorflow/tfjs"),tf_1=require("./utils/tf"),custom_mobilenet_1=require("./custom-mobilenet"),seedrandom=require("seedrandom"),VALIDATION_FRACTION=.15,isTensor=function(t){return"object"==typeof t.dataId&&"object"==typeof t.shape};function flatOneHot(t,e){var a=new Array(e).fill(0);return a[t]=1,a}function fisherYates(t,e){for(var a,r=t.length,n=t.slice(),i=r-1;i>0;i-=1){var o=void 0;a=[n[o=e?Math.floor(e()*(i+1)):Math.floor(Math.random()*(i+1))],n[i]],n[i]=a[0],n[o]=a[1]}return n}var TeachableMobileNet=function(t){function e(e,a){var r=t.call(this,tf.sequential(),a)||this;return r.totalSamples=0,r.examples=[],r.truncatedModel=e,r}return __extends(e,t),Object.defineProperty(e.prototype,"asSequentialModel",{get:function(){return this.model},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isTrained",{get:function(){return!!this.model&&this.model.layers&&this.model.layers.length>2},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPrepared",{get:function(){return!!this.trainDataset},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numClasses",{get:function(){return this._metadata.labels.length},enumerable:!1,configurable:!0}),e.prototype.addExample=function(t,e){return __awaiter(this,void 0,void 0,(function(){var a,r,n;return __generator(this,(function(i){return a=isTensor(e)?e:tf_1.capture(e,this._metadata.grayscale),r=this.truncatedModel.predict(a),n=r.dataSync(),a.dispose(),r.dispose(),this.examples[t].push(n),this.totalSamples++,[2]}))}))},e.prototype.predict=function(e,a){return void 0===a&&(a=!1),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){if(!this.model)throw new Error("Model has not been trained yet, called train() first");return[2,t.prototype.predict.call(this,e,a)]}))}))},e.prototype.predictTopK=function(e,a,r){return void 0===a&&(a=10),void 0===r&&(r=!1),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){if(!this.model)throw new Error("Model has not been trained yet, called train() first");return[2,t.prototype.predictTopK.call(this,e,a,r)]}))}))},e.prototype.prepare=function(){for(var t in this.examples)if(0===t.length)throw new Error("Add some examples before training");var e=this.convertToTfDataset();this.trainDataset=e.trainDataset,this.validationDataset=e.validationDataset},e.prototype.convertToTfDataset=function(){for(var t=0;t<this.examples.length;t++)this.examples[t]=fisherYates(this.examples[t],this.seed);var e=[],a=[],r=function(t){var r=flatOneHot(t,n.numClasses),i=n.examples[t].length,o=i-Math.ceil(VALIDATION_FRACTION*i),s=n.examples[t].slice(0,o).map((function(t){return{data:t,label:r}})),l=n.examples[t].slice(o).map((function(t){return{data:t,label:r}}));e=e.concat(s),a=a.concat(l)},n=this;for(t=0;t<this.examples.length;t++)r(t);e=fisherYates(e,this.seed),a=fisherYates(a,this.seed);var i=tf.data.array(e.map((function(t){return t.data}))),o=tf.data.array(a.map((function(t){return t.data}))),s=tf.data.array(e.map((function(t){return t.label}))),l=tf.data.array(a.map((function(t){return t.label})));return{trainDataset:tf.data.zip({xs:i,ys:s}),validationDataset:tf.data.zip({xs:o,ys:l})}},e.prototype.save=function(t,e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(a){return[2,this.model.save(t,e)]}))}))},e.prototype.train=function(t,e){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,(function(){var a,r,n,i,o,s,l,c,u,p=this;return __generator(this,(function(f){switch(f.label){case 0:if(a=e.onTrainEnd||function(){},e.onTrainEnd=function(t){p.__stopTrainingResolve&&(p.__stopTrainingResolve(),p.__stopTrainingResolve=null),a(t)},this.isPrepared||this.prepare(),r=this.getLabels().length,tfjs_1.util.assert(r===this.numClasses,(function(){return"Can not train, has "+r+" labels and "+p.numClasses+" classes"})),n=this.truncatedModel.outputs[0].shape.slice(1),i=tf.util.sizeFromShape(n),o=this.seed?tf.initializers.varianceScaling({seed:3.14}):tf.initializers.varianceScaling({}),this.trainingModel=tf.sequential({layers:[tf.layers.dense({inputShape:[i],units:t.denseUnits,activation:"relu",kernelInitializer:o,useBias:!0}),tf.layers.dense({kernelInitializer:o,useBias:!1,activation:"softmax",units:this.numClasses})]}),s=tf.train.adam(t.learningRate),this.trainingModel.compile({optimizer:s,loss:"categoricalCrossentropy",metrics:["accuracy"]}),!(t.batchSize>0))throw new Error("Batch size is 0 or NaN. Please choose a non-zero fraction");return l=this.trainDataset.batch(t.batchSize),c=this.validationDataset.batch(t.batchSize),[4,this.trainingModel.fitDataset(l,{epochs:t.epochs,validationData:c,callbacks:e})];case 1:return f.sent(),(u=tf.sequential()).add(this.truncatedModel),u.add(this.trainingModel),this.model=u,s.dispose(),[2,this.model]}}))}))},e.prototype.prepareDataset=function(){for(var t=0;t<this.numClasses;t++)this.examples[t]=[]},e.prototype.setLabel=function(t,e){this._metadata.labels[t]=e},e.prototype.setLabels=function(t){this._metadata.labels=t,this.prepareDataset()},e.prototype.getLabel=function(t){return this._metadata.labels[t]},e.prototype.getLabels=function(){return this._metadata.labels},e.prototype.setName=function(t){this._metadata.modelName=t},e.prototype.getName=function(){return this._metadata.modelName},e.prototype.stopTraining=function(){var t=this;return new Promise((function(e,a){t.trainingModel.stopTraining=!0,t.__stopTrainingResolve=e}))},e.prototype.dispose=function(){this.trainingModel.dispose(),t.prototype.dispose.call(this)},e.prototype.calculateAccuracyPerClass=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,a,r,n,i,o,s,l,c,u,p,f,h,d,_,b,m,v=this;return __generator(this,(function(y){switch(y.label){case 0:return t=this.validationDataset.mapAsync((function(t){return __awaiter(v,void 0,void 0,(function(){return __generator(this,(function(e){return[2,t.xs]}))}))})),e=this.validationDataset.mapAsync((function(t){return __awaiter(v,void 0,void 0,(function(){return __generator(this,(function(e){return[2,t.ys]}))}))})),a=Math.min(e.size,32),r=Math.ceil(e.size/a),n=t.batch(a),i=e.batch(a),[4,n.iterator()];case 1:return o=y.sent(),[4,i.iterator()];case 2:s=y.sent(),l=[],c=[],m=0,y.label=3;case 3:return m<r?[4,o.next()]:[3,7];case 4:return u=y.sent(),p=this.trainingModel.predict(u.value),f=p.argMax(1),l.push(f),[4,s.next()];case 5:h=y.sent(),d=h.value.argMax(1),c.push(d),u.value.dispose(),p.dispose(),h.value.dispose(),y.label=6;case 6:return m++,[3,3];case 7:if(_=tf.concat(c),b=tf.concat(l),1!==r)for(m=0;m<l.length;m++)l[m].dispose(),c[m].dispose();return[2,{reference:_,predictions:b}]}}))}))},e.prototype.setSeed=function(t){this.seed=seedrandom(t)},e}(custom_mobilenet_1.CustomMobileNet);function createTeachable(t,e){return __awaiter(this,void 0,void 0,(function(){var a;return __generator(this,(function(r){switch(r.label){case 0:return[4,custom_mobilenet_1.loadTruncatedMobileNet(e)];case 1:return a=r.sent(),[2,new TeachableMobileNet(a,t)]}}))}))}exports.TeachableMobileNet=TeachableMobileNet,exports.createTeachable=createTeachable;
//# sourceMappingURL=/sm/bb51a6a7ab5a33504361245ce8be06c224be9835ddf9ec85a446d219765213cd.map